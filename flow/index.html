<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=referrer content="never"><title>kotlin flow - FineSnow's Blog</title><meta name=Description content="Hugo theme - LoveIt"><meta property="og:title" content="kotlin flow">
<meta property="og:description" content="基础 Flow是一种基于流的编程模型，可以理解在Kotlin协程中提供的响应式编程方式就是Flow Flow的定义很简单，表示它是一个可以被订阅"><meta property="og:type" content="article"><meta property="og:url" content="https://example.com/flow/"><meta property="og:image" content="https://example.com/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-16T16:52:32+08:00"><meta property="article:modified_time" content="2022-12-12T20:44:53+08:00"><meta property="og:site_name" content="LoveIt"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://example.com/"><meta name=twitter:title content="kotlin flow"><meta name=twitter:description content="基础 Flow是一种基于流的编程模型，可以理解在Kotlin协程中提供的响应式编程方式就是Flow Flow的定义很简单，表示它是一个可以被订阅"><meta name=application-name content="FineSnow's Blog"><meta name=apple-mobile-web-app-title content="FineSnow's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://example.com/flow/><link rel=stylesheet href=//cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/lxgwwenkaiscreen.css media=print onload='this.media="all"'><link rel=prev href=https://example.com/%E7%94%9F%E6%B4%BB%E5%91%A8%E5%88%8A-008-%E8%BF%9C%E5%B1%B1%E6%B7%A1%E5%BD%B1/><link rel=next href=https://example.com/repeatonlifecycle-api%E8%AE%BE%E8%AE%A1%E6%95%85%E4%BA%8B/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"kotlin flow","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/example.com\/flow\/"},"image":["https:\/\/example.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"kotlin, flow, coroutine","wordcount":3169,"url":"https:\/\/example.com\/flow\/","datePublished":"2022-09-16T16:52:32+08:00","dateModified":"2022-12-12T20:44:53+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"FineSnow","logo":"https:\/\/example.com\/images\/avatar.png"},"author":{"@type":"Person","name":"FineSnow"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="FineSnow's Blog">FineSnow's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>主页 </a><a class=menu-item href=/books>阅读 </a><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about>关于 </a><a class=menu-item href=https://github.com/nullUfull/nullUfull.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="FineSnow's Blog">FineSnow's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/ title>主页</a><a class=menu-item href=/books title>阅读</a><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about title>关于</a><a class=menu-item href=https://github.com/nullUfull/nullUfull.github.io title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">kotlin flow</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>FineSnow</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%8A%80%E6%9C%AF/><i class="far fa-folder fa-fw" aria-hidden=true></i>技术</a></span></div><div class=post-meta-line><i class="far fa-calendar fa-fw"></i>&nbsp;<time datetime=2022-09-16>2022-09-16</time>&nbsp;<i class="far fa-calendar-plus fa-fw"></i>&nbsp;<time datetime=2022-12-12>2022-12-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 3169 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 7 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#基础>基础</a><ul><li><a href=#livedata>LiveData</a></li><li><a href=#冷流>冷流</a><ul><li><a href=#flow的创建>Flow的创建</a></li></ul></li><li><a href=#热流>热流</a><ul><li><a href=#sharedflow>SharedFlow</a></li><li><a href=#stateflow>StateFlow</a></li></ul></li><li><a href=#操作符>操作符</a><ul><li><a href=#终端操作符>终端操作符</a></li><li><a href=#中间操作符>中间操作符</a></li></ul></li><li><a href=#ui收集流的最佳实践>UI收集流的最佳实践</a></li><li><a href=#冷流转化为热流>冷流转化为热流</a><ul><li><a href=#共享策略>共享策略</a></li></ul></li><li><a href=#实战>实战</a><ul><li><a href=#简单示例>简单示例</a></li><li><a href=#flow实现数据拉取>Flow实现数据拉取</a></li><li><a href=#flow版本redux框架>Flow版本Redux框架</a></li></ul></li></ul></li><li><a href=#进阶>进阶</a></li><li><a href=#qa>Q&amp;A</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><h2 id=基础>基础</h2><p><code>Flow</code>是一种基于流的编程模型，可以理解在<code>Kotlin</code>协程中提供的响应式编程方式就是<code>Flow</code></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://developer.android.com/static/images/kotlin/flow/flow-entities.png data-srcset="https://developer.android.com/static/images/kotlin/flow/flow-entities.png, https://developer.android.com/static/images/kotlin/flow/flow-entities.png 1.5x, https://developer.android.com/static/images/kotlin/flow/flow-entities.png 2x" data-sizes=auto alt=https://developer.android.com/static/images/kotlin/flow/flow-entities.png title=https://developer.android.com/static/images/kotlin/flow/flow-entities.png></p><p><code>Flow</code>的定义很简单，表示它是一个可以被订阅收集的东西</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public interface Flow&lt;out T&gt; {
</span></span><span class=line><span class=cl>    @InternalCoroutinesApi
</span></span><span class=line><span class=cl>    public suspend fun collect(collector: FlowCollector&lt;T&gt;)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>而其中的<code>FlowCollector</code>代表流的接收者，其中定义了发送数据的功能。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public interface FlowCollector&lt;in T&gt; {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    /**
</span></span><span class=line><span class=cl>     * Collects the value emitted by the upstream.
</span></span><span class=line><span class=cl>     * This method is not thread-safe and should not be invoked concurrently.
</span></span><span class=line><span class=cl>     */
</span></span><span class=line><span class=cl>    public suspend fun emit(value: T)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=livedata>LiveData</h3><ol><li>简单易用，但难以处理复杂数据</li><li><code>postValue</code>丢失数据</li><li>数据倒灌</li><li>不防抖</li></ol><h3 id=冷流>冷流</h3><p><code>Flow</code>是一种 “冷流”(<code>Cold Stream</code>)。</p><p>冷流是一种数据源，该类数据源的生产者会在每个监听者开始消费事件的时候执行，从而在每个订阅上创建新的数据流。</p><p>这种冷流的行为我们可以从<code>SafeFlow</code>的实现中得知，在订阅的时候会执行传入的代码块：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private class SafeFlow&lt;T&gt;(private val block: suspend FlowCollector&lt;T&gt;.() -&gt; Unit) : AbstractFlow&lt;T&gt;() {
</span></span><span class=line><span class=cl>    override suspend fun collectSafely(collector: FlowCollector&lt;T&gt;) {
</span></span><span class=line><span class=cl>        // 执行代码块
</span></span><span class=line><span class=cl>        collector.block()
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>而一旦消费者停止监听（例如：<code>collect</code>所在协程被取消了），数据流将会被自动关闭，不会再发射数据。</p><ol><li>结构式并发；父子协程之间的关系；主从作用域、协同作用域</li><li>协程的取消</li><li><code>UI</code>层订阅<code>Flow</code>的最佳实践</li></ol><h4 id=flow的创建>Flow的创建</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>flow {
</span></span><span class=line><span class=cl>    delay(100) // ok
</span></span><span class=line><span class=cl>    emit(1) // ok
</span></span><span class=line><span class=cl>    withContext(Dispatcher.IO) {
</span></span><span class=line><span class=cl>        emit(2) // fail with ISE
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public fun &lt;T&gt; flow(
</span></span><span class=line><span class=cl>    @BuilderInference block: suspend FlowCollector&lt;T&gt;.() -&gt; Unit
</span></span><span class=line><span class=cl>): Flow&lt;T&gt; = SafeFlow(block)
</span></span></code></pre></td></tr></table></div></div><ol><li><code>flow</code>是一个高阶函数，参数是带接收者<code>FlowCollector</code>并且有<code>suspend</code>修饰符的函数类型，意味着<code>block</code>代码块中可以调用挂起函数</li><li><code>emit</code>函数不是线程安全的，不应该并发调用，所以再<code>flow</code>的代码块中不允许切换线程</li></ol><p>除此之外还封装了<code>asFlow</code>、<code>flowOf</code>等函数，都是基于<code>flow{}</code>实现的，方便调用方使用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>fun</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Iterable</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;.</span><span class=n>asFlow</span><span class=p>():</span> <span class=n>Flow</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>=</span> <span class=n>flow</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>forEach</span> <span class=p>{</span> <span class=n>value</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=n>FlowPreview</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>fun</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>(</span><span class=n>suspend</span> <span class=p>()</span> <span class=o>-&gt;</span> <span class=n>T</span><span class=p>)</span><span class=o>.</span><span class=n>asFlow</span><span class=p>():</span> <span class=n>Flow</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>=</span> <span class=n>flow</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>emit</span><span class=p>(</span><span class=n>invoke</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>fun</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>flowOf</span><span class=p>(</span><span class=n>vararg</span> <span class=n>elements</span><span class=p>:</span> <span class=n>T</span><span class=p>):</span> <span class=n>Flow</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=o>=</span> <span class=n>flow</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>element</span> <span class=ow>in</span> <span class=n>elements</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=热流>热流</h3><h4 id=sharedflow>SharedFlow</h4><p>共享流 1->n</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public interface SharedFlow&lt;out T&gt; : Flow&lt;T&gt; {
</span></span><span class=line><span class=cl>    /**
</span></span><span class=line><span class=cl>     * A snapshot of the replay cache.
</span></span><span class=line><span class=cl>     */
</span></span><span class=line><span class=cl>    public val replayCache: List&lt;T&gt;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>以广播方式在其所有<code>Flow</code>器之间共享发射值的热流，以便所有收集器获得所有发射值。共享流称为热流，因为它的活动实例独立于收集器的存在而存在。</p><p>这与常规<code>Flow</code>相反，例如由<code>flow { ... }</code>函数定义的，它是冷的并且为每个收集器单独启动。</p><p>共享流程永远不会完成。在共享流上调用<code>Flow.collect</code>永远不会正常完成，由<code>Flow.launchIn</code>函数启动的协程也不会正常完成。共享流的活动收集器称为订阅者。</p><h4 id=stateflow>StateFlow</h4><p>特殊的<code>ShareFlow</code> <code>replay = 1</code> 对标<code>LiveData</code>，必须有一个默认值，因为对外提供了一个接口用于获取当前值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public interface StateFlow&lt;out T&gt; : SharedFlow&lt;T&gt; {
</span></span><span class=line><span class=cl>    /**
</span></span><span class=line><span class=cl>     * The current value of this state flow.
</span></span><span class=line><span class=cl>     */
</span></span><span class=line><span class=cl>    public val value: T
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>事件：事件是一次有效的，新订阅者不应该收到旧的事件，事件数据适合用<code>SharedFlow</code>(replay=0)
状态：状态是可以恢复的，新订阅者允许收到旧的状态数据，状态数据适合用<code>StateFlow</code></p><p>比如说<code>ViewModel</code>通知<code>View</code>显示一个弹窗提示，切后台后回来会走<code>onStart</code>，会重新订阅事件对应的<code>Flow</code>，因此会再次收到事件，而显示弹窗</p><h3 id=操作符>操作符</h3><h4 id=终端操作符>终端操作符</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>collect
</span></span><span class=line><span class=cl>collectLatest // 有新值发出时，如果此时上个收集还没完成，则会取消掉上个值的收集操作并开始新收集操作
</span></span><span class=line><span class=cl>fold
</span></span><span class=line><span class=cl>reduce
</span></span><span class=line><span class=cl>lanchIn
</span></span><span class=line><span class=cl>first // 返回流发出的第一个元素然后取消流收集，如果为空会抛异常
</span></span><span class=line><span class=cl>firstOrNull // 返回流发出的第一个元素然后取消流收集。如果流为空，则返回null 
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><h4 id=中间操作符>中间操作符</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=err>回调</span>
</span></span><span class=line><span class=cl><span class=n>onStart</span>
</span></span><span class=line><span class=cl><span class=n>onEach</span>
</span></span><span class=line><span class=cl><span class=n>onCompletion</span>
</span></span><span class=line><span class=cl><span class=n>onEmpty</span>
</span></span><span class=line><span class=cl><span class=n>onSubscription</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>变换</span>
</span></span><span class=line><span class=cl><span class=n>transform</span> <span class=o>//</span> <span class=err>对发出的值进行变换</span>
</span></span><span class=line><span class=cl><span class=n>transformLatest</span> <span class=o>//</span> <span class=err>当原始流发出一个新值时，前一个</span><span class=n>transform块被取消</span>
</span></span><span class=line><span class=cl><span class=n>transformWhile</span> <span class=o>//</span> <span class=err>这个变换的</span><span class=n>lambda的返回值为Boolean</span><span class=err>，如果为</span><span class=n>false则不再进行后续变换</span><span class=err>（取消订阅），为</span><span class=n>ture则继续执行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fun</span> <span class=n>Flow</span><span class=o>&lt;</span><span class=n>DownloadProgress</span><span class=o>&gt;.</span><span class=n>completeWhenDone</span><span class=p>():</span> <span class=n>Flow</span><span class=o>&lt;</span><span class=n>DownloadProgress</span><span class=o>&gt;</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=n>transformWhile</span> <span class=p>{</span> <span class=n>progress</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=n>emit</span><span class=p>(</span><span class=n>progress</span><span class=p>)</span> <span class=o>//</span> <span class=n>always</span> <span class=n>emit</span> <span class=n>progress</span>
</span></span><span class=line><span class=cl>        <span class=o>!</span><span class=n>progress</span><span class=o>.</span><span class=n>isDone</span><span class=p>()</span> <span class=o>//</span> <span class=k>continue</span> <span class=k>while</span> <span class=n>download</span> <span class=n>is</span> <span class=ow>not</span> <span class=n>done</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>map</span>
</span></span><span class=line><span class=cl><span class=n>mapNotNull</span>
</span></span><span class=line><span class=cl><span class=n>mapLatest</span> <span class=o>//</span> <span class=err>当有新值发送时如果上个变换还没结束，会先取消掉</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>过滤</span>
</span></span><span class=line><span class=cl><span class=n>filter</span>
</span></span><span class=line><span class=cl><span class=n>filterInstance</span>
</span></span><span class=line><span class=cl><span class=n>filterNot</span>
</span></span><span class=line><span class=cl><span class=n>filterNotNull</span>
</span></span><span class=line><span class=cl><span class=n>takeWhile</span> <span class=o>//</span> <span class=err>返回包含满足给定</span><span class=n>predicate的第一个元素的流</span>
</span></span><span class=line><span class=cl><span class=n>debounce</span> <span class=o>//</span> <span class=err>防抖节流，指定时间内的值只接收最新的一个，其他的过滤掉。搜索联想场景适用</span>
</span></span><span class=line><span class=cl><span class=n>sample</span> <span class=o>//</span> <span class=err>采样</span>
</span></span><span class=line><span class=cl><span class=n>distinctUntilChanged</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>组合</span>
</span></span><span class=line><span class=cl><span class=n>combine</span>
</span></span><span class=line><span class=cl><span class=n>combineTransform</span>
</span></span><span class=line><span class=cl><span class=n>merge</span>
</span></span><span class=line><span class=cl><span class=n>flattenConcat</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=err>功能</span>
</span></span><span class=line><span class=cl><span class=n>merge</span>
</span></span><span class=line><span class=cl><span class=n>catch</span>
</span></span><span class=line><span class=cl><span class=n>buffer</span>
</span></span><span class=line><span class=cl><span class=n>conflate</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ui收集流的最佳实践>UI收集流的最佳实践</h3><p>生命周期？资源浪费？</p><p>launch vs launchWhenX vs repeatOnLifecycle</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://miro.medium.com/max/720/0*pDKnvDJ9FzaCgXCd data-srcset="https://miro.medium.com/max/720/0*pDKnvDJ9FzaCgXCd, https://miro.medium.com/max/720/0*pDKnvDJ9FzaCgXCd 1.5x, https://miro.medium.com/max/720/0*pDKnvDJ9FzaCgXCd 2x" data-sizes=auto alt=https://miro.medium.com/max/720/0*pDKnvDJ9FzaCgXCd title=https://miro.medium.com/max/720/0*pDKnvDJ9FzaCgXCd></p><ul><li><p><code>launch</code>
和视图的生命周期同步</p></li><li><p><code>launchWhenX</code>
在应用程序处于后台时接收更新可能会导致崩溃，这可以通过暂停视图中的收集来解决。然而，当应用程序在后台时，上游流量保持活跃，可能会浪费资源</p></li><li><p><code>repeatOnLifecycle</code>（Best Practices）
可以在每当生命周期处于<code>STARED</code>会在新的协程中启动执行代码块，并在生命周期进入<code>STOPPED</code>时取消协程，即取消<code>Flow</code>的收集</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    // 创建新的协程
</span></span><span class=line><span class=cl>    lifecycleScope.launch {
</span></span><span class=line><span class=cl>        // 每当生命周期处于STARED会在新的协程中启动执行代码块，并在生命周期进入STOPPED时取消协程
</span></span><span class=line><span class=cl>        repeatOnLifecycle(Lifecycle.State.STARTED) {
</span></span><span class=line><span class=cl>            // 当生命周期处于STARTED时安全地从flow中获取数据，生命周期进入STOPPED时停止收集数据
</span></span><span class=line><span class=cl>            viewModel.coldFlow.collect {
</span></span><span class=line><span class=cl>                Log.i(&#34;FlowTest&#34;, &#34;repeatOnLifecycle $it&#34;)
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>        // 当运行到此处，生命周期已进入DESTROYED状态
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        repeatOnLifecycle(Lifecycle.State.STARTED) {
</span></span><span class=line><span class=cl>            viewModel.coldFlow.collect {
</span></span><span class=line><span class=cl>                Log.i(&#34;FlowTest&#34;, &#34;repeatOnLifecycle $it&#34;)
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span></code></pre></td></tr></table></div></div><h3 id=冷流转化为热流>冷流转化为热流</h3><p>使用<code>shareIn</code>or<code>shateIn</code>扩展方法可以使冷流转化为热流</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public fun &lt;T&gt; Flow&lt;T&gt;.shareIn(
</span></span><span class=line><span class=cl>    scope: CoroutineScope, // 指定开始共享的协程作用域
</span></span><span class=line><span class=cl>    started: SharingStarted, // 控制什么时候启动和停止共享的策略
</span></span><span class=line><span class=cl>    replay: Int = 0 // 重播给新订阅者的值的数量(不能为负数，默认为零)
</span></span><span class=line><span class=cl>): SharedFlow&lt;T&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public fun &lt;T&gt; Flow&lt;T&gt;.stateIn(
</span></span><span class=line><span class=cl>    scope: CoroutineScope,
</span></span><span class=line><span class=cl>    started: SharingStarted,
</span></span><span class=line><span class=cl>    initialValue: T // 初始值
</span></span><span class=line><span class=cl>): StateFlow&lt;T&gt;
</span></span></code></pre></td></tr></table></div></div><h4 id=共享策略>共享策略</h4><ul><li><code>SharingStarted.Eagerly</code> 立即开始共享并且不会停止</li><li><code>SharingStarted.Lazily</code> 当收个订阅者出现时开始共享并且会停止</li><li><code>SharingStarted.WhileSubscribed</code> 当第一个订阅者出现时开始共享，当最后一个订阅者消失时立即停止共享（默认），永远保持重播缓存（默认）</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public fun WhileSubscribed(
</span></span><span class=line><span class=cl>    stopTimeoutMillis: Long = 0, // 配置最后一个订阅者消失和共享协程停止之间的延迟（以毫秒为单位)，默认为零（立即停止）
</span></span><span class=line><span class=cl>    replayExpirationMillis: Long = Long.MAX_VALUE // 配置共享协程停止和重放缓存重置之间的延迟（以毫秒为单位）默认为Long.MAX_VALUE（永远保留重放缓存，不重置缓冲区）
</span></span><span class=line><span class=cl>)
</span></span></code></pre></td></tr></table></div></div><p>推荐使用<code>SharingStarted.WhileSubscribed(5000)</code>共享策略作为默认实现</p><ol><li>如果<code>Activity</code>配置发生改变，数据是不会丢的，5000ms足够<code>Activity</code>从配置改变到恢复</li><li>可以搭配<code>repeatOnLifecycle</code>（UI层安全收集流）使用，如果应用切后台则UI层会取消对于流的<code>collect</code>（取消订阅），而这里因为配置<code>WhileSubscribed</code>策略超时后会自动停止共享，共享流会断开对上游冷流的<code>collect</code>（取消订阅），上游冷流的数据的生产也就会被<code>cancel</code>掉，避免应用处于后台时还存在数据的生产</li></ol><h3 id=实战>实战</h3><h4 id=简单示例>简单示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>class BooksRepository{
</span></span><span class=line><span class=cl>    val userData = flow {
</span></span><span class=line><span class=cl>        emit(Book(&#34;1984&#34;))
</span></span><span class=line><span class=cl>        emit(Book(&#34;茶馆&#34;))
</span></span><span class=line><span class=cl>        emit(Book(&#34;一句顶一万句&#34;))
</span></span><span class=line><span class=cl>        emit(Book(&#34;山月记&#34;))
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>class BookViewModel{
</span></span><span class=line><span class=cl>     val books: StateFlow&lt;List&lt;BookState&gt;&gt; = 
</span></span><span class=line><span class=cl>        booksRepository.userData
</span></span><span class=line><span class=cl>            .filter { it.author == &#34;刘震云&#34; }
</span></span><span class=line><span class=cl>            .stateIn(
</span></span><span class=line><span class=cl>                scope = viewModelScope,
</span></span><span class=line><span class=cl>                started = SharingStarted.WhileSubscribed(5_000),
</span></span><span class=line><span class=cl>                initialValue = BooksFeedUiState.Loading
</span></span><span class=line><span class=cl>            )
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>class BookListFragment : Fragment() {
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    private fun initObserver() {
</span></span><span class=line><span class=cl>        lifecycleScope.launch {
</span></span><span class=line><span class=cl>            repeatOnLifecycle(Lifecycle.State.STARTED) {
</span></span><span class=line><span class=cl>                viewModel.books.collect { adapter.submitList(it) }
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h4 id=flow实现数据拉取>Flow实现数据拉取</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>class</span> <span class=n>VideoDetailRepository</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>val</span> <span class=n>api</span> <span class=n>by</span> <span class=n>lazy</span> <span class=p>{</span> <span class=n>NetworkApi</span><span class=o>.</span><span class=n>getInstance</span><span class=p>()</span><span class=o>.</span><span class=n>createApi</span><span class=p>(</span><span class=n>MovieApi</span><span class=p>::</span><span class=k>class</span><span class=o>.</span><span class=n>java</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fun</span> <span class=n>getVideoSelectData</span><span class=p>(</span><span class=n>videoSelectRequest</span><span class=p>:</span> <span class=n>VideoSelectRequest</span><span class=p>):</span> <span class=n>Flow</span><span class=o>&lt;</span><span class=n>Result</span><span class=o>&lt;</span><span class=n>VideoSelectResponse</span><span class=o>&gt;&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>api</span><span class=o>.</span><span class=n>getVideoSelect</span><span class=p>(</span><span class=n>videoSelectRequest</span><span class=o>.</span><span class=n>toStGetVideoSelectReq</span><span class=p>())</span><span class=o>.</span><span class=n>map</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>it</span><span class=o>.</span><span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Result</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=n>it</span><span class=o>.</span><span class=n>toVideoSelectResponse</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Result</span><span class=o>.</span><span class=n>failure</span><span class=p>(</span><span class=n>Exception</span><span class=p>(</span><span class=n>it</span><span class=o>.</span><span class=n>msg</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span><span class=o>.</span><span class=n>catch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>emit</span><span class=p>(</span><span class=n>Result</span><span class=o>.</span><span class=n>failure</span><span class=p>(</span><span class=n>it</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>ViewModel</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>val</span> <span class=n>store</span> <span class=n>by</span> <span class=n>lazyStore</span><span class=p>(::</span><span class=n>videoSelectReducer</span><span class=p>,</span> <span class=n>VideoSelectState</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=n>state</span> <span class=n>get</span><span class=p>()</span> <span class=o>=</span> <span class=n>store</span><span class=o>.</span><span class=n>state</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>init</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModelScope</span><span class=o>.</span><span class=n>launch</span><span class=p>(</span><span class=n>Dispatchers</span><span class=o>.</span><span class=n>IO</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>loadTypeFlow</span><span class=o>.</span><span class=n>transform</span> <span class=p>{</span> <span class=n>loadType</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                <span class=n>store</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>UpdateLoadStateAndType</span><span class=p>(</span><span class=n>LoadState</span><span class=o>.</span><span class=n>LOADING</span><span class=p>,</span> <span class=n>loadType</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=n>repository</span><span class=o>.</span><span class=n>getVideoSelectData</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>createVideoSelectRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>_curVideoSelectModel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>loadType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>state</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>pageState</span><span class=o>.</span><span class=n>attachInfo</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span><span class=o>.</span><span class=n>let</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>emitAll</span><span class=p>(</span><span class=n>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=o>.</span><span class=n>collect</span> <span class=p>{</span> <span class=n>result</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                <span class=n>Logger</span><span class=o>.</span><span class=n>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s2>&#34;curVideoSelectModel = $_curVideoSelectModel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span><span class=o>.</span><span class=n>onSuccess</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Logger</span><span class=o>.</span><span class=n>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s2>&#34;load data success, size = ${it.videoInfo.size}&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>store</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>LoadDataSuccess</span><span class=p>(</span><span class=n>curVideoSelectStyle</span><span class=p>,</span> <span class=n>it</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span><span class=o>.</span><span class=n>onFailure</span> <span class=p>{</span> <span class=n>throwable</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=n>Logger</span><span class=o>.</span><span class=n>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s2>&#34;getVideoSelectData&#34;</span><span class=p>,</span> <span class=n>throwable</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>store</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>UpdateLoadState</span><span class=p>(</span><span class=n>LoadState</span><span class=o>.</span><span class=n>ERROR</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>....</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>VideoSelectFragment</span> <span class=p>:</span> <span class=n>Fragment</span><span class=p>(</span><span class=n>R</span><span class=o>.</span><span class=n>layout</span><span class=o>.</span><span class=n>fragment_video_select</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>fun</span> <span class=n>initObserver</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>map</span> <span class=p>{</span> <span class=n>it</span><span class=o>.</span><span class=n>pageState</span><span class=o>.</span><span class=n>canLoadBackward</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>distinctUntilChanged</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>launchAndCollectIn</span><span class=p>(</span><span class=n>viewLifecycleOwner</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>viewBinding</span><span class=o>.</span><span class=n>refreshLayout</span><span class=o>.</span><span class=n>setEnableLoadMore</span><span class=p>(</span><span class=n>it</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>viewModel</span><span class=o>.</span><span class=n>state</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>map</span> <span class=p>{</span> <span class=n>it</span><span class=o>.</span><span class=n>videoItemStates</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>distinctUntilChanged</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>launchAndCollectIn</span><span class=p>(</span><span class=n>viewLifecycleOwner</span><span class=p>)</span> <span class=p>{</span> <span class=n>dataList</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>                <span class=n>pictureTextSelectAdapter</span><span class=o>.</span><span class=n>submitList</span><span class=p>(</span><span class=n>dataList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inline</span> <span class=n>fun</span> <span class=o>&lt;</span><span class=n>reified</span> <span class=n>T</span><span class=o>&gt;</span> <span class=n>Flow</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;.</span><span class=n>launchAndCollectIn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span><span class=p>:</span> <span class=n>LifecycleOwner</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>minActiveState</span><span class=p>:</span> <span class=n>Lifecycle</span><span class=o>.</span><span class=n>State</span> <span class=o>=</span> <span class=n>Lifecycle</span><span class=o>.</span><span class=n>State</span><span class=o>.</span><span class=n>STARTED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>collector</span><span class=p>:</span> <span class=n>FlowCollector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>=</span> <span class=n>owner</span><span class=o>.</span><span class=n>lifecycleScope</span><span class=o>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>owner</span><span class=o>.</span><span class=n>repeatOnLifecycle</span><span class=p>(</span><span class=n>minActiveState</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=err>@</span><span class=n>launchAndCollectIn</span><span class=o>.</span><span class=n>collect</span><span class=p>(</span><span class=n>collector</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=flow版本redux框架>Flow版本Redux框架</h4><p><a href=https://github.com/nullUfull/FlowRedux target=_blank rel="noopener noreffer">完整代码仓库</a></p><h2 id=进阶>进阶</h2><p>look forward to</p><h2 id=qa>Q&amp;A</h2><h2 id=参考>参考</h2><p><a href=https://github.com/android/nowinandroid target=_blank rel="noopener noreffer">nowinandroid</a></p><p><a href=https://juejin.cn/post/7078225994871472158 target=_blank rel="noopener noreffer">实战 | 使用 Kotlin Flow 构建数据流 &ldquo;管道&rdquo;</a></p><p><a href=https://juejin.cn/post/7001371050202103838 target=_blank rel="noopener noreffer">设计repeatOnLifecycle API 背后的故事</a></p><p><a href=https://medium.com/androiddevelopers/repeatonlifecycle-api-design-story-8670d1a7d333 target=_blank rel="noopener noreffer">repeatOnLifecycle API design story</a></p><p><a href=https://medium.com/androiddevelopers/a-safer-way-to-collect-flows-from-android-uis-23080b1f8bda target=_blank rel="noopener noreffer">A safer way to collect flows from Android UIs</a></p><p><a href=https://juejin.cn/post/6998066384290709518 target=_blank rel="noopener noreffer">Flow 操作符 shareIn 和 stateIn 使用须知</a></p><p><a href=https://myungpyo.medium.com/deep-dive-into-coroutine-flow-2-d43ba0d1f45d target=_blank rel="noopener noreffer">Deep dive into Coroutine Flow 2</a></p><p><a href=https://medium.com/androiddevelopers/migrating-from-livedata-to-kotlins-flow-379292f419fb target=_blank rel="noopener noreffer">Migrating from LiveData to Kotlin’s Flow</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-12-12&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/914a9cb975b3b966eaaa7d786cdfdad450f30e68 target=_blank title="commit by alkaidwang(alkaidwang@tencent.com) 914a9cb975b3b966eaaa7d786cdfdad450f30e68: update">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>914a9cb</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/flow/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://example.com/flow/ data-title="kotlin flow" data-hashtags=kotlin,flow,coroutine><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://example.com/flow/ data-hashtag=kotlin><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://example.com/flow/ data-title="kotlin flow"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://example.com/flow/ data-title="kotlin flow"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://example.com/flow/ data-title="kotlin flow"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/kotlin/>Kotlin</a>,&nbsp;<a href=/tags/flow/>Flow</a>,&nbsp;<a href=/tags/coroutine/>Coroutine</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/%E7%94%9F%E6%B4%BB%E5%91%A8%E5%88%8A-008-%E8%BF%9C%E5%B1%B1%E6%B7%A1%E5%BD%B1/ class=prev rel=prev title="生活周刊 008 远山淡影"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>生活周刊 008 远山淡影</a>
<a href=/repeatonlifecycle-api%E8%AE%BE%E8%AE%A1%E6%95%85%E4%BA%8B/ class=next rel=next title="repeatOnLifecycle API设计故事">repeatOnLifecycle API设计故事<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><span>Blog 共 81320 字<br>写完一本 鲁迅 的</br>《呐喊》了！</span></div></footer><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.123.7">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>FineSnow</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=/js/custom.js></script></body></html>